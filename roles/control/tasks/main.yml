---

- name: Set Architecture Alias
  set_fact:
    arch_alias: >-
      {% if ansible_architecture == 'x86_64' %}amd64{% elif ansible_architecture == 'aarch64' %}arm64{% else %}{{ ansible_architecture }}{% endif %}


- name:  Downloading Kubernetes {{ kube_version }} Components
  amazon.aws.s3_object:
    endpoint_url: "{{ s3_endpoint_url }}"
    access_key: "{{ s3_access_key }}"
    secret_key: "{{ s3_secret_key }}"
    bucket: "{{ s3_bucket_name }}"
    object: "kubernetes/{{ kube_version }}/linux/{{ arch_alias }}/{{ item }}"
    dest: "{{ kubernetes_home }}/bin/{{ item }}"
    mode: get
    overwrite: different
  async: 6000
  poll: 10
  loop:
    - kube-apiserver
    - kube-controller-manager
    - kube-scheduler
    - kubectl

- name: Grant Executable Permissions For Components
  ansible.builtin.shell: chmod +x {{ kubernetes_home }}/bin/*


- name: Install SSL Certificate
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: root 
    group: root 
    mode: 0640
  with_items:
  - { src: "ca-config.json", dest: "{{ kubernetes_home }}/ssl/ca-config.json" }
  - { src: "{{ inventory_dir }}/{{ root_cert }}", dest: "{{ kubernetes_home }}/ssl/ca.pem" }
  - { src: "{{ inventory_dir }}/{{ root_key }}", dest: "{{ kubernetes_home }}/ssl/key.pem" }
  - { src: "bootstrap.yaml", dest: "{{ kubernetes_home }}/etc/bootstrap.yaml" }

- name: Install Kube-Master Systemd Config
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: root
    group: root
    mode: 0640
  with_items:
  - { src: "token", dest: "{{ kubernetes_home }}/ssl/token" }
  - { src: "kube-admin-csr.json", dest: "{{ kubernetes_home }}/ssl/kube-admin-csr.json" }
  - { src: "kube-apiserver-csr.json", dest: "{{ kubernetes_home }}/ssl/kube-apiserver-csr.json" }
  - { src: "kube-controller-manager-csr.json", dest: "{{ kubernetes_home }}/ssl/kube-controller-manager-csr.json" }
  - { src: "kube-scheduler-csr.json", dest: "{{ kubernetes_home }}/ssl/kube-scheduler-csr.json" }
  - { src: "kube-apiserver.conf", dest: "{{ kubernetes_home }}/etc/kube-apiserver.conf" }
  - { src: "kube-controller-manager.conf", dest: "{{ kubernetes_home }}/etc/kube-controller-manager.conf" }
  - { src: "kube-scheduler.conf", dest: "{{ kubernetes_home }}/etc/kube-scheduler.conf" }
  - { src: "kube-apiserver.service.j2", dest: "/usr/lib/systemd/system/kube-apiserver.service" }
  - { src: "kube-controller-manager.service.j2", dest: "/usr/lib/systemd/system/kube-controller-manager.service" }
  - { src: "kube-scheduler.service.j2", dest: "/usr/lib/systemd/system/kube-scheduler.service" }
  - { src: "cilium-helm-release.yml", dest: "{{ kubernetes_home }}/etc/cilium-helm-release.yml" }
  - { src: "coredns.yml", dest: "{{ kubernetes_home }}/etc/coredns.yml" }
  - { src: "ip-masq-agent.yml", dest: "{{ kubernetes_home }}/etc/ip-masq-agent.yml" }


- name: Generate SSL Certificates
  shell: |
    cfssl gencert -ca=ca.pem -ca-key=key.pem -config=ca-config.json kube-admin-csr.json  | cfssljson -bare kube-admin
    cfssl gencert -ca=ca.pem -ca-key=key.pem -config=ca-config.json kube-apiserver-csr.json  | cfssljson -bare kube-apiserver  
    cfssl gencert -ca=ca.pem -ca-key=key.pem -config=ca-config.json kube-controller-manager-csr.json  | cfssljson -bare kube-controller-manager
    cfssl gencert -ca=ca.pem -ca-key=key.pem -config=ca-config.json kube-scheduler-csr.json  | cfssljson -bare kube-scheduler
  args:
    chdir: "{{ kubernetes_home }}/ssl"

- name: Install Master Kubeconfig
  template:
    src: "master.kubeconfig"
    dest: "{{ item.dest }}"
    owner: root
    group: root
    mode: 0600
  with_items:
  - { dest: "/root/.kube/config", context_user: "kube-admin" }
  - { dest: "{{ kubernetes_home }}/etc/kube-admin.kubeconfig", context_user: "kube-admin" }
  - { dest: "{{ kubernetes_home }}/etc/kube-controller-manager.kubeconfig", context_user: "kube-controller-manager" }
  - { dest: "{{ kubernetes_home }}/etc/kube-scheduler.kubeconfig", context_user: "kube-scheduler" }
  changed_when: True

- name: Enable Kubernetes Master Service
  ansible.builtin.service:
    name: "{{ item }}"
    enabled: yes
    state: started
  with_items:
  - 'kube-apiserver'
  - 'kube-controller-manager'
  - 'kube-scheduler'

- name: Install Client Certificate Auto Approve
  shell: |
    ln -sfT {{ kubernetes_home }}/bin/kubectl /usr/local/bin/kubectl
    kubectl apply -f {{ kubernetes_home }}/etc/bootstrap.yaml


- name: Downloading Helm
  amazon.aws.s3_object:
    endpoint_url: "{{ s3_endpoint_url }}"
    access_key: "{{ s3_access_key }}"
    secret_key: "{{ s3_secret_key }}"
    bucket: "{{ s3_bucket_name }}"
    object: "helm/{{ helm_version }}/linux/{{ arch_alias }}/helm-{{ helm_version }}-linux-{{ arch_alias }}.tar.gz"
    dest: "/tmp/helm-{{ helm_version }}-linux-{{ arch_alias }}.tar.gz"
    mode: get
    overwrite: different
  async: 6000
  poll: 10
  retries: 5
  delay: 10

- name: Install Helm
  ansible.builtin.shell: | 
    tar --strip-components=1  -xf /tmp/helm-{{ helm_version }}-linux-{{ arch_alias }}.tar.gz -C /usr/local/bin/
    rm -f /usr/local/README.md /usr/local/LICENSE
    rm -f /tmp/helm-{{ helm_version }}-linux-{{ arch_alias }}.tar.gz
    chmod +x /usr/local/bin/helm

- name: Downloading Cilium Cli
  amazon.aws.s3_object:
    endpoint_url: "{{ s3_endpoint_url }}"
    access_key: "{{ s3_access_key }}"
    secret_key: "{{ s3_secret_key }}"
    bucket: "{{ s3_bucket_name }}"
    object: "cilium/cilium-cli/{{ cilium_cli_version }}/linux/cilium-linux-{{ arch_alias }}.tar.gz"
    dest: "/tmp/cilium-linux-{{ arch_alias }}.tar.gz"
    mode: get
    overwrite: different
  async: 6000
  poll: 10
  when: cni_plugin == 'cilium'
  retries: 5
  delay: 10


- name: Install Cilium Cli
  ansible.builtin.shell: | 
    tar -xf /tmp/cilium-linux-{{ arch_alias }}.tar.gz -C /usr/local/bin/
    chmod +x /usr/local/bin/cilium
  when: cni_plugin == 'cilium'