apiVersion: apps/v1
kind: Deployment
metadata:
  name: cbb-flow-engin
  namespace: devops
  labels:
    app: cbb-flow-engin
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cbb-flow-engin
  template:
    metadata:
      labels:
        app: cbb-flow-engin
    spec:
      volumes:
        - name: cbb-flow-engin-log
          emptyDir:
            sizeLimit: 1Gi
      containers:
        - name: cbb-flow-engin
          image: {{cbb_flow_engin}}
          ports:
            - name: debug
              containerPort: 10514
              protocol: TCP
            - name: dubbo
              containerPort: 10511
              protocol: TCP
            - name: power-job
              containerPort: 10512
              protocol: TCP
            - name: web
              containerPort: 10510
              protocol: TCP
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
            - name: JVM
              value: '1024'
            - name: JVM_CUSTOM
              value: ' -Denv=TEST -Dfile.encoding=utf-8 -Dspring.cloud.nacos.config.file-extension=properties -Dspring.cloud.nacos.config.server-addr=nacos.public.svc.cluster.local:8848 -Dspring.cloud.nacos.config.username=nacos -Dspring.cloud.nacos.config.password=nacos -Dspring.cloud.nacos.discovery.server-addr=nacos.public.svc.cluster.local:8848 -Dspring.cloud.nacos.discovery.username=nacos -Dspring.cloud.nacos.discovery.password=nacos --add-opens=java.management/sun.management=ALL-UNNAMED --add-opens=java.base/sun.net=ALL-UNNAMED --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.math=ALL-UNNAMED --add-opens=java.base/jdk.internal.misc=ALL-UNNAMED -XX:+UnlockExperimentalVMOptions -XX:MaxRAM=1G -XX:InitialRAMPercentage=10 -XX:MinRAMPercentage=50 -XX:MaxRAMPercentage=70 -Xms512m -Xmx1024m -server -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:10514'
            - name: TZ
              value: Asia/Shanghai
            - name: APP_NAME
              value: cbb-flow-engin
            - name: LANG
              value: en_US.UTF-8
            - name: PROJECT_NAME
              value: cbb-flow-engin
            - name: WEBPORT
              value: '10510'
            - name: isolate
              value: video-sheng
            - name: LOG_KAFKA_REGION
              value: e30=
            - name: SENTINEL_URL
              value: '-'
            - name: CODE_VERSION
              value: '17'
            - name: DUBBO_ENV_KEYS
              value: zone,isolate
            - name: JVMMN
              value: '512'
            - name: ISKUBERAPP
              value: 'true'
            - name: CONFIG_ENV
              value: TEST
          resources:
            limits:
              cpu: '1'
              memory: 2Gi
            requests:
              cpu: 250m
              memory: 512Mi
          volumeMounts:
            - name: cbb-flow-engin-log
              mountPath: /home/docker/logs
          readinessProbe:
            httpGet:
              path: /hc.do?a=healthCheck
              port: 10510
              scheme: HTTP
            timeoutSeconds: 1
            periodSeconds: 5
            successThreshold: 1
            failureThreshold: 2
          imagePullPolicy: IfNotPresent
      restartPolicy: Always
      imagePullSecrets:
        - name: regcred

---

apiVersion: v1
kind: Service
metadata:
  name: cbb-flow-engin-svc
  namespace: devops
spec:
  ports:
    - name: debug
      protocol: TCP
      port: 10514
      targetPort: 10514
    - name: dubbo
      protocol: TCP
      port: 10511
      targetPort: 10511
    - name: power-job
      protocol: TCP
      port: 10512
      targetPort: 10512
    - name: web
      protocol: TCP
      port: 10510
      targetPort: 10510
  selector:
    app: cbb-flow-engin
  type: ClusterIP

