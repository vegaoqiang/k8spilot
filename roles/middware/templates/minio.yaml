# apiVersion: v1
# kind: PersistentVolume
# metadata:
#   name: minio-local-pv
# spec:
#   capacity:
#     storage: 100Gi
#   volumeMode: Filesystem
#   accessModes:
#     - ReadWriteOnce
#   persistentVolumeReclaimPolicy: Delete
#   local:
#     path: /mnt/data/minio
#   nodeAffinity:
#     required:
#       nodeSelectorTerms:
#         - matchExpressions:
#             - key: kubernetes.io/hostname
#               operator: In
#               values:
#                 - "{{ groups['schedulernode'] | random  }}"

---

kind: Service
apiVersion: v1
metadata:
  name: minio
  namespace: "{{ middware_namespace }}"
  labels:
    app: minio
spec:
  selector:
    app: minio
  ports:
    - name: minio-api
      port: 80
      targetPort: 9000
    - name: minio-web-ui
      port: 9090
      targetPort: 9090
---
kind: Service
apiVersion: v1
metadata:
  name: minio-nodeport
  namespace: "{{ middware_namespace }}"
  labels:
    app: minio
spec:
  selector:
    app: minio
  ports:
    - name: minio-api-nodeport
      port: 9000
      nodePort: 39000
    - name: minio-web-ui-nodeport
      port: 9090
      nodePort: 39090
  type: NodePort
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: minio
  namespace: "{{ middware_namespace }}"
  labels:
    app: minio
spec:
  serviceName: "minio"
  replicas: 1
  selector:
    matchLabels:
      app: minio
  template:
    metadata:
      labels:
        app: minio
    spec:
      containers:
      - name: minio
        image: reg.guideirai.online/base/minio:{{minio_version}}
        ports:
        - containerPort: 9000
          name: minio-api
        - containerPort: 9090
          name: minio-web-ui
        env:
        - name: MINIO_ROOT_USER
          value: admin
        - name: MINIO_ROOT_PASSWORD
          value: gsdt@002414
        volumeMounts:
        - name: minio-pvc
          mountPath: /data
        args:
        - "server"
        - "/data"
        - "--console-address"
        - ":9090"
      imagePullSecrets:
        - name: regcred
  volumeClaimTemplates: # This is the specification in which you reference the StorageClass
  - metadata:
      name: minio-pvc
      namespace: "{{ middware_namespace }}"
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 100Gi
  