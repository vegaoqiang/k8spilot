
- name: Check Cilium {{ cilium_version }} Helm Chart Exists
  ansible.builtin.stat:
    path: "{{ component_path }}/cilium-{{ cilium_version| replace('v', '') }}.tgz"
  delegate_to: localhost
  run_once: true
  register: cilium_stat

- name: Cilium {{ cilium_version }} Offline File Not Exist
  ansible.builtin.fail:
    msg: "{{ component_path }}/cilium-{{ cilium_version| replace('v', '') }}.tgz not exists"
  when: not cilium_stat.stat.exists and method == 'offline'

- name: Downloading Cilium Helm Chart
  ansible.builtin.get_url:
    url: "{{ cilium_download_url_prefix }}/cilium-{{ cilium_version| replace('v', '') }}.tgz"
    dest: "{{ component_path }}/cilium-{{ cilium_version| replace('v', '') }}.tgz"
    mode: '0755'
    timeout: 60
  # amazon.aws.s3_object:
  #   endpoint_url: "{{ s3_endpoint_url }}"
  #   access_key: "{{ s3_access_key }}"
  #   secret_key: "{{ s3_secret_key }}"
  #   bucket: "{{ s3_bucket_name }}"
  #   object: "cilium/cilium/cilium-{{ cilium_version| replace('v', '') }}.tgz"
  #   dest: "{{ component_path }}/cilium-{{ cilium_version| replace('v', '') }}.tgz"
  #   mode: get
  #   overwrite: different
  delegate_to: localhost
  run_once: true
  when: not cilium_stat.stat.exists and method == 'online'

- name: Copy  Cilium Helm Chart To Remote Host
  ansible.builtin.copy:
    src: "{{ component_path }}/cilium-{{ cilium_version| replace('v', '') }}.tgz"
    dest: "/tmp/cilium-{{ cilium_version| replace('v', '') }}.tgz"

- name: Copy Cilium Values Override File
  ansible.builtin.template:
    src: "value.override.yaml.j2"
    dest: "/tmp/cilium-values-override.yaml"
    mode: '0644'

- name: Process Offline Images
  include_tasks: offline.yml
  when: method == 'offline'

- name: Install Cilium
  ansible.builtin.shell: |
    helm upgrade --install cilium /tmp/cilium-{{ cilium_version| replace('v', '') }}.tgz --namespace kube-system --values /tmp/cilium-values-override.yaml




